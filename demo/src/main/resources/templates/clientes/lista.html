<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes - ERP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link th:href="@{/css/clientes.css}" rel="stylesheet">
</head>
<body>
<!-- Sidebar -->
<aside class="sidebar">
    <div class="logo">
        <div class="logo-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                <path d="M2 17l10 5 10-5"/>
                <path d="M2 12l10 5 10-5"/>
            </svg>
        </div>
        <span class="logo-text">ERP</span>
    </div>
    <nav>
        <ul class="nav-menu">
            <li class="nav-item">
                <a th:href="@{/inicio}" class="nav-link">
                    <i class="bi bi-house-door"></i>
                    <span>Inicio</span>
                </a>
            </li>
            <li class="nav-item">
                <a th:href="@{/clientes}" class="nav-link active">
                    <i class="bi bi-people"></i>
                    <span>Clientes</span>
                </a>
            </li>
            <li class="nav-item">
                <a th:href="@{/trabajadores}" class="nav-link">
                    <i class="bi bi-person-badge"></i>
                    <span>Trabajadores</span>
                </a>
            </li>
            <li class="nav-item">
                <a th:href="@{/proveedores}" class="nav-link">
                    <i class="bi bi-truck"></i>
                    <span>Proveedores</span>
                </a>
            </li>
            <li class="nav-item">
                <a th:href="@{/productos}" class="nav-link">
                    <i class="bi bi-box-seam"></i>
                    <span>Productos</span>
                </a>
            </li>
            <li class="nav-item">
                <a th:href="@{/pedidos}" class="nav-link">
                    <i class="bi bi-cart3"></i>
                    <span>Pedidos</span>
                </a>
            </li>
        </ul>
    </nav>
</aside>

<!-- Main Content -->
<main class="main-content">
    <!-- Header -->
    <header class="header">
        <div class="search-box">
            <i class="bi bi-search"></i>
            <input type="text" placeholder="Buscar...">
        </div>
        <div class="header-right">
            <button class="icon-btn">
                <i class="bi bi-envelope"></i>
            </button>
            <button class="icon-btn notification">
                <i class="bi bi-bell"></i>
                <span class="badge-notify">3</span>
            </button>
            <div class="user-profile">
                <div class="user-avatar">AD</div>
                <div class="user-info">
                    <div class="user-name" th:text="${usuario.username}">Usuario</div>
                    <span class="user-role">Cuenta Admin</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Alertas -->
    <div th:if="${exito}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-2"></i>
        <span th:text="${exito}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard-container">
        <!-- Panel Principal de Clientes -->
        <section class="clientes-panel">
            <div class="panel-header">
                <h1 class="panel-title">Clientes</h1>
                <div class="search-filter">
                    <form th:action="@{/clientes}" method="get" class="search-form">
                        <input type="text" name="busqueda" th:value="${busqueda}" placeholder="Buscar...">
                        <button type="submit"><i class="bi bi-search"></i></button>
                    </form>
                </div>
            </div>

            <div class="panel-content">
                <!-- Estadísticas Circulares -->
                <div class="stats-row">
                    <div class="stat-circle activo">
                        <svg viewBox="0 0 36 36" class="circular-chart">
                            <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                            <path class="circle" th:stroke-dasharray="${estadisticas.porcentajeActivos + ', 100'}" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                        </svg>
                        <div class="stat-text">
                            <span class="stat-percent" th:text="${estadisticas.porcentajeActivos + '%'}">70%</span>
                            <span class="stat-label">Activos</span>
                        </div>
                    </div>
                    <div class="stat-circle pendiente">
                        <svg viewBox="0 0 36 36" class="circular-chart">
                            <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                            <path class="circle" th:stroke-dasharray="${estadisticas.porcentajePendientes + ', 100'}" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                        </svg>
                        <div class="stat-text">
                            <span class="stat-percent" th:text="${estadisticas.porcentajePendientes + '%'}">20%</span>
                            <span class="stat-label">Pendiente</span>
                        </div>
                    </div>
                    <div class="stat-circle baja">
                        <svg viewBox="0 0 36 36" class="circular-chart">
                            <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                            <path class="circle" th:stroke-dasharray="${estadisticas.porcentajeBajas + ', 100'}" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                        </svg>
                        <div class="stat-text">
                            <span class="stat-percent" th:text="${estadisticas.porcentajeBajas + '%'}">10%</span>
                            <span class="stat-label">Baja</span>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Clientes -->
                <div class="table-container">
                    <table class="clientes-table">
                        <thead>
                        <tr>
                            <th>
                                <a th:href="@{/clientes(ordenarPor='id', direccion=${direccion == 'asc' ? 'desc' : 'asc'})}">
                                    Id <i class="bi bi-arrow-down-up"></i>
                                </a>
                            </th>
                            <th>
                                <a th:href="@{/clientes(ordenarPor='nombre', direccion=${direccion == 'asc' ? 'desc' : 'asc'})}">
                                    Nombre <i class="bi bi-arrow-down-up"></i>
                                </a>
                            </th>
                            <th>Correo</th>
                            <th>
                                <a th:href="@{/clientes(ordenarPor='credito', direccion=${direccion == 'asc' ? 'desc' : 'asc'})}">
                                    Crédito <i class="bi bi-arrow-down-up"></i>
                                </a>
                            </th>
                            <th>
                                <a th:href="@{/clientes(ordenarPor='fechaRegistro', direccion=${direccion == 'asc' ? 'desc' : 'asc'})}">
                                    Fecha <i class="bi bi-arrow-down-up"></i>
                                </a>
                            </th>
                            <th>
                                <a th:href="@{/clientes(ordenarPor='estado', direccion=${direccion == 'asc' ? 'desc' : 'asc'})}">
                                    Estado <i class="bi bi-arrow-down-up"></i>
                                </a>
                            </th>
                            <th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="cliente, iterStat : ${clientes}">
                            <td th:text="${iterStat.index + 1 + (paginaActual * tamanio)}">1.</td>
                            <td th:text="${cliente.nombre}">Alonso</td>
                            <td th:text="${cliente.correo}">..@gmail.com</td>
                            <td th:text="${#numbers.formatDecimal(cliente.credito, 0, 'COMMA', 0, 'POINT') + '€'}">10000€</td>
                            <td th:text="${#temporals.format(cliente.fechaRegistro, 'dd MMM yyyy')}">25 Nov 2025</td>
                            <td>
                                        <span class="badge-estado"
                                              th:classappend="${cliente.estado.name() == 'ACTIVO' ? 'activo' : (cliente.estado.name() == 'PENDIENTE' ? 'pendiente' : 'baja')}"
                                              th:text="${cliente.estado}">Activo</span>
                            </td>
                            <td class="acciones">
                                <a th:href="@{/clientes/ver/{id}(id=${cliente.id})}" class="btn-action ver" title="Ver">
                                    <i class="bi bi-list"></i>
                                </a>
                                <a th:href="@{/clientes/editar/{id}(id=${cliente.id})}" class="btn-action editar" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a th:href="@{/clientes/eliminar/{id}(id=${cliente.id})}"
                                   class="btn-action eliminar"
                                   title="Eliminar"
                                   onclick="return confirm('¿Estás seguro de eliminar este cliente?')">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(clientes)}">
                            <td colspan="7" class="text-center py-4">No hay clientes registrados</td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Paginación -->
                <nav class="pagination-container" th:if="${totalPaginas > 1}">
                    <ul class="pagination">
                        <li class="page-item" th:classappend="${paginaActual == 0} ? 'disabled'">
                            <a class="page-link" th:href="@{/clientes(pagina=${paginaActual - 1}, tamanio=${tamanio})}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                        <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPaginas - 1)}"
                            th:if="${i < 3 || i == totalPaginas - 1 || (i >= paginaActual - 1 && i <= paginaActual + 1)}"
                            th:classappend="${i == paginaActual} ? 'active'">
                            <a class="page-link" th:href="@{/clientes(pagina=${i}, tamanio=${tamanio})}" th:text="${i + 1}">1</a>
                        </li>
                        <li class="page-item disabled" th:if="${totalPaginas > 5}">
                            <span class="page-link">...</span>
                        </li>
                        <li class="page-item" th:if="${totalPaginas > 5 && paginaActual < totalPaginas - 3}">
                            <a class="page-link" th:href="@{/clientes(pagina=${totalPaginas - 1}, tamanio=${tamanio})}" th:text="${totalPaginas}">32</a>
                        </li>
                        <li class="page-item" th:classappend="${paginaActual == totalPaginas - 1} ? 'disabled'">
                            <a class="page-link" th:href="@{/clientes(pagina=${paginaActual + 1}, tamanio=${tamanio})}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </section>

        <!-- Panel Lateral Derecho -->
        <aside class="side-panel">
            <!-- Botones de Acción -->
            <div class="action-buttons">
                <a th:href="@{/clientes/nuevo}" class="btn-crear">
                    <i class="bi bi-plus-lg"></i> Crear cliente
                </a>
                <button class="btn-eliminar" data-bs-toggle="modal" data-bs-target="#modalEliminar">
                    <i class="bi bi-trash"></i> Eliminar cliente
                </button>
                <button class="btn-filtrar" data-bs-toggle="dropdown">
                    <i class="bi bi-funnel"></i> Filtrar cliente
                </button>
                <ul class="dropdown-menu dropdown-filtros">
                    <li><a class="dropdown-item" th:href="@{/clientes}">Todos</a></li>
                    <li><a class="dropdown-item" th:href="@{/clientes/filtrar/ACTIVO}">Activos</a></li>
                    <li><a class="dropdown-item" th:href="@{/clientes/filtrar/PENDIENTE}">Pendientes</a></li>
                    <li><a class="dropdown-item" th:href="@{/clientes/filtrar/BAJA}">Baja</a></li>
                </ul>
            </div>

            <!-- Total Clientes -->
            <div class="total-clientes">
                <span class="total-numero" th:text="${estadisticas.total}">150</span>
                <span class="total-texto">Clientes Registrados</span>
            </div>
        </aside>
    </div>

    <!-- Sección Inferior: Clientes Recientes y Top Clientes -->
    <div class="bottom-section">
        <!-- Clientes Recientes -->
        <div class="card-section">
            <h2 class="section-title">Clientes Recientes</h2>
            <table class="mini-table">
                <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Crédito</th>
                    <th>Fecha</th>
                    <th>Total</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="cliente : ${clientesRecientes}">
                    <td th:text="${cliente.nombre}">Alonso</td>
                    <td th:text="${#numbers.formatDecimal(cliente.credito, 0, 'COMMA', 0, 'POINT') + '€'}">10000€</td>
                    <td th:text="${#temporals.format(cliente.fechaRegistro, 'dd MMM yyyy')}">25 Nov 2025</td>
                    <td class="total-col" th:text="${#numbers.formatDecimal(cliente.credito * 0.75, 0, 'COMMA', 2, 'POINT') + '€'}">75.67€</td>
                </tr>
                </tbody>
            </table>
            <nav class="mini-pagination">
                <span class="page-indicator active">1</span>
                <span class="page-indicator">2</span>
                <span class="page-indicator">3</span>
                <span class="page-dots">...</span>
                <span class="page-indicator">32</span>
                <i class="bi bi-chevron-right"></i>
            </nav>
        </div>

        <!-- Top Clientes -->
        <div class="card-section">
            <h2 class="section-title">Top Clientes</h2>
            <table class="mini-table">
                <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Crédito</th>
                    <th>Fecha</th>
                    <th>Total</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="cliente : ${topClientes}">
                    <td th:text="${cliente.nombre}">Alonso</td>
                    <td th:text="${#numbers.formatDecimal(cliente.credito, 0, 'COMMA', 0, 'POINT') + '€'}">10000€</td>
                    <td th:text="${#temporals.format(cliente.fechaRegistro, 'dd MMM yyyy')}">25 Nov 2025</td>
                    <td class="total-col" th:text="${#numbers.formatDecimal(cliente.credito * 0.75, 0, 'COMMA', 2, 'POINT') + '€'}">75.67€</td>
                </tr>
                </tbody>
            </table>
            <nav class="mini-pagination">
                <span class="page-indicator active">1</span>
                <span class="page-indicator">2</span>
                <span class="page-indicator">3</span>
                <span class="page-dots">...</span>
                <span class="page-indicator">32</span>
                <i class="bi bi-chevron-right"></i>
            </nav>
        </div>
    </div>
</main>

<!-- Modal Eliminar -->
<div class="modal fade" id="modalEliminar" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Eliminar Cliente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Selecciona el cliente que deseas eliminar:</p>
                <select class="form-select" id="selectEliminar">
                    <option th:each="cliente : ${clientes}" th:value="${cliente.id}" th:text="${cliente.nombre}"></option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="eliminarClienteSeleccionado()">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    function eliminarClienteSeleccionado() {
        const select = document.getElementById('selectEliminar');
        const clienteId = select.value;
        if (clienteId) {
            if (confirm('¿Estás seguro de eliminar este cliente?')) {
                window.location.href = '/clientes/eliminar/' + clienteId;
            }
        }
    }
</script>
</body>
</html>